# Dependency Vulnerability Scanning

This project runs **dependency vulnerability scanning** in CI. Pull requests are **blocked** when high or critical vulnerabilities are found in frontend (npm) or backend (Python) dependencies.

## Tools Used

| Stack    | Tool       | Purpose                          |
|----------|------------|-----------------------------------|
| Frontend | `npm audit`| Scan npm dependencies for CVEs   |
| Backend  | `pip-audit`| Scan pip dependencies for CVEs   |

The workflow runs on every **pull request** and **push** to `main` and `develop`. If the audit fails, the PR cannot be merged until vulnerabilities are fixed or explicitly accepted (see [Suppressing acceptable exceptions](#suppressing-acceptable-exceptions)).

---

## Configuring Which Severities Block CI

### Frontend (npm)

The minimum severity that fails the pipeline is set by the **`NPM_AUDIT_LEVEL`** environment variable in [.github/workflows/dependency-audit.yml](../.github/workflows/dependency-audit.yml).

| Value      | Effect: PR is blocked when…        |
|-----------|-------------------------------------|
| `critical`| Only critical vulnerabilities      |
| `high`    | High or critical (default)         |
| `moderate`| Moderate, high, or critical         |
| `low`     | Any vulnerability                  |

To change it, edit the `env` block in the workflow:

```yaml
env:
  NPM_AUDIT_LEVEL: "high"   # change to "critical", "moderate", or "low"
```

### Backend (pip-audit)

`pip-audit` currently fails the job when **any** vulnerability is reported. There is no severity filter in the tool itself. To allow specific vulnerabilities (e.g. accepted risks), use the [ignore list](#suppressing-acceptable-exceptions) below.

---

## How to Resolve Identified Vulnerabilities

### Frontend (npm)

1. **Run the audit locally**
   ```bash
   npm audit
   ```
2. **Apply automatic fixes where possible**
   ```bash
   npm audit fix
   ```
3. **For breaking or major upgrades**, review and upgrade manually:
   ```bash
   npm audit fix --force   # may introduce breaking changes; test thoroughly
   ```
   Or update specific packages:
   ```bash
   npm update <package-name>
   # or
   npm install <package-name>@latest
   ```
4. **Re-run the audit**
   ```bash
   npm audit --audit-level=high
   ```
5. Commit the updated `package.json` and `package-lock.json` and push. CI will run the same check.

### Backend (Python)

1. **Run the audit locally**
   ```bash
   pip install pip-audit
   pip-audit -r requirements.txt
   pip-audit -r infra/lambda/requirements.txt
   ```
2. **Act on the report**  
   `pip-audit` prints each vulnerability and, when available, fix versions. Update your `requirements.txt` (or Lambda `requirements.txt`) to use the suggested versions, for example:
   ```text
   # Before (vulnerable)
   requests==2.28.0

   # After (fixed)
   requests==2.31.0
   ```
3. **Reinstall and re-audit**
   ```bash
   pip install -r requirements.txt
   pip-audit -r requirements.txt
   ```
4. Commit the updated `requirements.txt` and push. CI will run the same check.

---

## Suppressing Acceptable Exceptions

Sometimes a vulnerability is **accepted** (e.g. false positive, no fix yet, or accepted risk with mitigation). In those cases you can suppress it so it does not block CI.

### Process for adding an exception

1. **Document the exception**  
   In the PR or in a comment in the repo, record:
   - The vulnerability ID (e.g. CVE-2024-12345).
   - Why it is accepted (e.g. “Not in our code path”, “Mitigated by network policy”, “No fix available; tracking in ISSUE-123”).
   - A short expiry or review date if it is temporary.

2. **Add the ID to the ignore list**  
   Edit [.github/pip-audit-ignore.txt](../.github/pip-audit-ignore.txt) and add one vulnerability ID per line. Lines starting with `#` and blank lines are ignored.

   **Example `.github/pip-audit-ignore.txt`:**
   ```text
   # Accepted: not used in production code path. Review in Q3.
   CVE-2024-12345
   # Pending upstream fix; tracked in ISSUE-456
   PYSEC-2024-42
   ```

3. **Only for Python**  
   The ignore list is used only by `pip-audit` in the backend-audit job. npm does not use this file.

### npm exceptions

For npm, use [audit exceptions](https://docs.npmjs.com/cli/v8/commands/npm-audit#audit-level) via `package.json` or `npm audit` configuration, or adjust `NPM_AUDIT_LEVEL` in the workflow if you want to allow lower severities. Prefer fixing or upgrading over suppressing.

---

## Integration with Dependabot

- **Dependabot** is configured in [.github/dependabot.yml](../.github/dependabot.yml) for npm, pip, GitHub Actions, Docker, and Terraform.
- It opens PRs to bump dependencies on a schedule. When those PRs are opened, the **Dependency Vulnerability Audit** workflow runs and will block merge if new high/critical vulnerabilities are present.
- Workflow: **Dependabot PR → dependency-audit workflow runs → PR blocked if vulns → fix or suppress → merge.**

This keeps dependency updates and vulnerability scanning aligned: Dependabot proposes updates, and the audit ensures we don’t merge PRs that introduce or retain blocking vulnerabilities.
